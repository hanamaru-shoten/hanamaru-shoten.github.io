<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OPENREC.tv éå…¬å¼ã‚³ãƒ¡ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã‚¢</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <h1>OPENREC.tv éå…¬å¼ã‚³ãƒ¡ãƒ“ãƒ¥</h1>

    <div id="stream-info">
      <!-- é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ«ã¨é…ä¿¡è€…ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ† -->
      é…ä¿¡ã‚¿ã‚¤ãƒˆãƒ« by é…ä¿¡è€…
    </div>

    <div id="image-wrapper">
      <!-- ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®imgè¦ç´  -->
      <img
        id="streamer-icon"
        src="https://image-handler.openrec.tv/eyJidWNrZXQiOiJvcGVucmVjLWFwcGRhdGEiLCJrZXkiOiJ1c2VyLzI1LzI0OTgucG5nIiwiZWRpdHMiOnsicmVzaXplIjp7ImZpdCI6Imluc2lkZSIsIndpZHRoIjoiMzIwIn19LCJvdXRwdXRGb3JtYXQiOiJwbmcifQ=="
      />
    </div>

    <div id="connection-info">
      <!-- ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒã¸ã®æ¥ç¶šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ† -->
      >> æ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
    </div>

    <!-- M_IDã‚’å…¥åŠ›ã™ã‚‹å…¥åŠ›æ¬„ã¨æ¥ç¶šãƒœã‚¿ãƒ³ -->
    <div>
      <input
        type="text"
        id="m_id_input"
        placeholder="æ IDã‚’å…¥åŠ›(ä¾‹:é…ä¿¡URLãŒhttps://www.openrec.tv/live/od97q6ecuptãªã‚‰od97q6ecuptã‚’å…¥åŠ›)"
      />
      <button onclick="connectToChat()">æ¥ç¶š</button>
    </div>

    <div id="viewers-monitor">
      <!-- åŒæ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ† -->
    </div>

    <div id="table_container">
      <table id="chat-table">
        <thead>
          <tr>
            <th id="attribute-cell">å±æ€§ğŸ›ˆï¸</th>
            <th>subsc</th>
            <th>ãƒ¦ãƒ¼ã‚¶å</th>
            <th>ID</th>
            <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
            <th>æŠ•ç¨¿æ™‚é–“</th>
          </tr>
        </thead>
        <tbody id="chat-body">
          <!-- ã‚³ãƒ¡ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹éƒ¨åˆ† -->
        </tbody>
      </table>
    </div>

    <!-- å±æ€§èª¬æ˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="attribute-discription">
      ğŸ”°â†’æ–°è¦ãƒ¦ãƒ¼ã‚¶ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå¾Œ24æ™‚é–“çµŒéã§æ¶ˆãˆã‚‹ã€‚è¨­å®šã§éè¡¨ç¤ºã«ã§ãã‚‹ã€‚<br />
      ğŸ¤–â†’ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã€‚ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ç™»éŒ²ã¨è§£é™¤ã¯é…ä¿¡è€…ã®ã¿å¯èƒ½ã€‚<br />
      ğŸ…¿â†’ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã€‚å¤§å¤‰ã‚ã‚ŠãŒãŸã„ãŠå®¢æ§˜ã€‚è¨­å®šã§éè¡¨ç¤ºã«ã§ãã‚‹ã€‚<br />
      ğŸ”‡â†’ãƒŸãƒ¥ãƒ¼ãƒˆãƒ¦ãƒ¼ã‚¶ã€‚é…ä¿¡è€…ã«ã‚ˆã£ã¦ãƒŸãƒ¥ãƒ¼ãƒˆã«ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ã€‚ä»–äººã‹ã‚‰è‡ªåˆ†ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ãˆãªããªã‚‹ã€‚<br />
      âš ï¸â†’è­¦å‘Šãƒ¦ãƒ¼ã‚¶ã€‚100äººä»¥ä¸Šã«ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆè¿½åŠ ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ã€‚æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ã¯ä¸æ˜ã€‚<br />
    </div>

    <script>
      document.getElementById("viewers-monitor").innerHTML = `â—åŒæ¥: -`;
      let activeSocket = null; // WebSocketæ¥ç¶šã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®å¤‰æ•°

      // å…¥åŠ›ã•ã‚ŒãŸURLã‹ã‚‰æ IDã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
      function extractFrameIDFromURL(url) {
        const match = url.match(/\/live\/([^\/]+)/);
        if (match && match[1]) {
          return match[1];
        }
        return null;
      }

      // ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒã¸ã®æ¥ç¶šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
      function displayConnectionMessage(message) {
        const connectionInfo = document.getElementById("connection-info");
        const timestamp = new Date().toLocaleTimeString();
        connectionInfo.innerText = `${message} (${timestamp})`;
      }

      // æ¥ç¶šãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
      function connectToChat() {
        let frameID = document.getElementById("m_id_input").value.trim();
        document.getElementById("viewers-monitor").innerHTML = `â—åŒæ¥: -`;

        // å…¥åŠ›ã•ã‚ŒãŸå€¤ãŒURLã®å ´åˆã€æ IDã‚’æŠ½å‡ºã—ã¦ã‚»ãƒƒãƒˆã™ã‚‹
        if (frameID.includes("https://www.openrec.tv/live/")) {
          frameID = extractFrameIDFromURL(frameID);
          if (!frameID) {
            alert("æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
          document.getElementById("m_id_input").value = frameID;
        }

        const base_url = `https://public.openrec.tv/external/api/v5/movies/${frameID}`;
        fetch(base_url)
          .then((response) => response.json())
          .then((movie_data) => {
            const iconImage = movie_data.channel.icon_image_url;
            document.getElementById("streamer-icon").src = iconImage;

            const title = movie_data.title;

            const streamer_nickname = movie_data.channel.nickname;
            const streamer_id = movie_data.channel.id;
            const stream_link = `<a href="https://www.openrec.tv/live/${frameID}" target="_blank">ã€Œ${title}ã€</a>`;
            const streamer_link = `<a href="https://www.openrec.tv/user/${streamer_id}" target="_blank">${streamer_nickname}(@${streamer_id})</a>`;

            const movie_id = movie_data.movie_id;

            document.getElementById(
              "stream-info"
            ).innerHTML = `${stream_link} by ${streamer_link}`;

            const web = `wss://chat.openrec.tv/socket.io/?movieId=${movie_id}&EIO=3&transport=websocket`;

            if (activeSocket) {
              activeSocket.close(); // å‰ã®WebSocketæ¥ç¶šã‚’é–‰ã˜ã‚‹
            }

            const ws = new WebSocket(web);
            activeSocket = ws; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªWebSocketæ¥ç¶šã‚’ä¿å­˜

            ws.onopen = function () {
              displayConnectionMessage(">> ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¾ã—ãŸï¼");
              sendPingMessage(ws);
              // æ–°ã—ã„æ¥ç¶šãŒç¢ºç«‹ã•ã‚ŒãŸéš›ã«ã€ãƒãƒ£ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹ã®å†…å®¹ã‚’ç©ºã«ã™ã‚‹
              // chat-allã®å­è¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¶ˆå»ã™ã‚‹
              document.querySelectorAll("#chat-body > tr").forEach((tr) => {
                tr.remove(); // è¡Œã‚’å‰Šé™¤
              });
            };

            ws.onmessage = function (event) {
              try {
                const message = event.data;
                const index = message.indexOf("[");
                if (index === 2) {
                  const msg_j = message.slice(2);
                  const json_obj = JSON.parse(
                    JSON.parse(msg_j)[1].replace("\\", "")
                  );
                  const data = json_obj.data;
                  const t = json_obj.type;

                  if (t === 0) {
                    if (
                      data.hasOwnProperty("stamp") &&
                      data.stamp !== null &&
                      data.stamp.image_url !== null
                    ) {
                      // stampãŒå­˜åœ¨ã—ã€image_urlãŒnullã§ãªã„å ´åˆã®å‡¦ç†
                      stamp = data.stamp.image_url; // stampã«data.stamp.image_urlã‚’ä»£å…¥
                    } else {
                      stamp = false; // stampã«falseã‚’ä»£å…¥
                    }

                    let {
                      is_fresh,
                      is_moderator,
                      is_premium,
                      is_muted,
                      is_warned,
                      months,
                      badges,
                    } = user_info(data);

                    let {
                      user_name,
                      user_key,
                      message,
                      message_dt,
                      user_icon,
                      user_color,
                    } = data;

                    message_dt = message_dt.slice(-8);
                    //subsc = ;

                    const attribute = `${is_fresh}${is_moderator}${is_premium}${is_muted}${is_warned}`;

                    // displayMessageRow é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                    displayMessageRow(
                      message,
                      attribute,
                      months,
                      badges,
                      user_key,
                      message_dt,
                      user_name,
                      user_color,
                      stamp
                    );
                  }

                  if (t === 1) {
                    const { live_viewers } = data;
                    document.getElementById(
                      "viewers-monitor"
                    ).innerHTML = `â—åŒæ¥:${live_viewers}`;
                  }
                }
              } catch (error) {
                console.log(`WebSocketã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`);
              }
            };

            ws.onclose = function () {
              console.log("æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ");
              // å†æ¥ç¶šã®ãŸã‚ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
            };

            ws.onerror = function (error) {
              console.log("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            };
          })
          .catch((error) => {
            console.log("APIå®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            displayConnectionMessage(
              ">> æ¥ç¶šã§ãã¾ã›ã‚“ï¼å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼"
            );
          });
      }

      function displayMessageRow(
        message,
        attribute,
        months,
        badges,
        user_key,
        message_dt,
        user_name,
        user_color,
        stamp
      ) {
        const chatBody = document.getElementById("chat-body");
        const newRow = chatBody.insertRow();

        // ä»¥ä¸‹ã€é †ç•ªã«æ³¨æ„
        newRow.insertCell().textContent = attribute;

        // Monthsã¨Badgesã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ãŸã‚ã®ã‚»ãƒ«
        const monthsBadgesCell = newRow.insertCell();
        // Badgesã®ç”»åƒã‚’è¿½åŠ 
        if (badges) {
          const badgesElement = document.createElement("img");
          badgesElement.src = badges;
          badgesElement.classList.add("badge-image"); // ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          monthsBadgesCell.appendChild(badgesElement);
        }
        // Monthsã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
        const monthsText = document.createElement("span");
        monthsText.textContent = months;
        monthsBadgesCell.appendChild(monthsText);

        // user_nameã®ã‚»ãƒ«ã‚’ä½œæˆã—ã€ãƒªãƒ³ã‚¯ã‚’è¨­å®šã™ã‚‹
        const userNameCell = newRow.insertCell();
        const userLink = document.createElement("a");
        userLink.href = `https://www.openrec.tv/user/${user_key}`;
        userLink.target = "_blank"; // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        userLink.textContent = user_name;
        userLink.style.color = user_color;
        userLink.classList.add("user-link"); // æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        userNameCell.appendChild(userLink);

        // user_keyã®ã‚»ãƒ«ã‚’ä½œæˆã—ã€ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦å†…å®¹ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
        const userKeyCell = newRow.insertCell();
        userKeyCell.textContent = user_key;
        userKeyCell.classList.add("user-key-cell"); // æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 

        // stampãŒFalseãªã‚‰ã€messageã«æ–‡å­—åˆ—ãŒã‚ã‚‹ã®ã§ãã®ã¾ã¾æŒ¿å…¥
        if (stamp === false) {
          newRow.insertCell().textContent = message;
        } else {
          // æ–°ã—ã„ã‚»ãƒ«ã‚’ä½œæˆã—ã€ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®imgè¦ç´ ã‚’è¿½åŠ ã—ã¾ã™
          const stampCell = newRow.insertCell();
          const stampImage = document.createElement("img");
          stampImage.src = stamp;
          stampImage.classList.add("img-stamp"); // CSSã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          stampCell.appendChild(stampImage);
        }

        newRow.insertCell().textContent = message_dt;
      }

      function sendPingMessage(ws) {
        const pingInterval = 25000;
        setInterval(function () {
          if (!isOpen(ws)) return; // WebSocketãŒé–‹ã„ã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã›ãšã«çµ‚äº†
          ws.send("2");
        }, pingInterval);
      }

      // WebSocketãŒé–‹ã„ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
      function isOpen(ws) {
        return ws.readyState === WebSocket.OPEN;
      }

      function user_info(data) {
        let is_fresh = data.is_fresh ? "ğŸ”°" : "";
        let is_moderator = data.is_moderator ? "ğŸ¤–" : "";
        let is_premium = data.is_premium ? "ğŸ…¿" : "";
        let is_muted = data.is_muted ? "ğŸ”‡" : "";
        let is_warned = data.is_warned ? "âš ï¸" : "";
        let months = "";
        let badges = "";

        if (data.badges && data.badges.length > 0) {
          months = `${data.badges[0].subscription.months}`;
          badges = `${data.badges[0].image_url}`;
        }

        return {
          is_fresh,
          is_moderator,
          is_premium,
          is_muted,
          is_warned,
          months,
          badges,
        };
      }
      // å±æ€§ä¸Šã®ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã®ç›£è¦–
      // å±æ€§ã‚»ãƒ«ã®è¦ç´ ã‚’å–å¾—
      const attributeCell = document.getElementById("attribute-cell");

      // å±æ€§èª¬æ˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¦ç´ ã‚’å–å¾—
      const attributeDiscription = document.getElementById(
        "attribute-discription"
      );

      // ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
      attributeCell.addEventListener("mouseover", function () {
        attributeDiscription.style.display = "block";
      });

      // ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’éè¡¨ç¤º
      attributeCell.addEventListener("mouseout", function () {
        attributeDiscription.style.display = "none";
      });
    </script>
  </body>
</html>
